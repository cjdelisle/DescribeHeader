# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
#
# This is part of the EcoNet Ethernet driver
# It the section of memory mapped registers for one QDMA system.
# For the driver. See: https://github.com/cjdelisle/econet_eth
#
type: struct
name: qregs
desc: QDMA Registers
fields:
  - type: word
    name: version
    bits: 32
  - type: struct
    name: qdma_cfg
    short_name: qcfg
    fields:
      - type: bitfield
        bits: 32
        fields:
          - name: rx_2b_offset
            bits: 1
            desc: If enabled, use (dscp_pkt_ptr + 2) as starting address for rx payload
          - name: dma_preference
            short_name: dma_pref
            bits: 2
            enum:
              ROUND_ROBIN: 0
              FRX_TX1_TX0: 1
              TX1_FRX_TX0: 2
              TX1_TX0_FRX: 3
            desc: DMA channel scheduling preference, FRX means "Forwarding and RX"
          - name: msg_word_swap
            bits: 1
            desc: Enable message word swap, don't know what this does but every implementation
                  sets it on Big Endian.
          - name: dscp_byte_swap
            bits: 1
            desc: Endian-swap packet descriptors (?), drivers always set this on Big Endian machines.
          - name: payload_byte_sw
            bits: 1
            desc: Endian-swap payload bytes, drivers always set this on Big Endian machines.
          - name: vchnl_map_en
            bits: 1
            desc: Enable virtual mapping to group queues per physical channel
          - name: vchnl_map_mode
            bits: 1
            desc: Map of 4 virtual channels per physical channel, 0 = map 2
          - desc: Reserved
            bits: 1
          - name: qdma_lpbk_rxq_sel
            bits: 1
            desc: If enabled, qdma loopback goes to queue 1, otherwise it goes to queue zero
          - name: slm_release_en
            bits: 1
            desc: Enable qdma fwd path release slm_block
          - name: tx_immediate_done
            bits: 1
            desc: QDMA generate pkt_done itself instead of using pse pkt_done
          - name: irq_en
            bits: 1
            desc: Enable "interrupt queue" (i.e. Done List) for tx dma done
          - desc: Reserved
            bits: 1
          - name: gdm_loopback
            bits: 1
            desc: Enable gdm loopback tx packet to rx path
          - name: qdma_loopback
            bits: 1
            desc: Enable hw qdma loopback tx packet to rx path
          - desc: Reserved
            bits: 8
          - name: check_done
            bits: 1
            desc: Check the done bit of descriptor and don't use descriptors which are marked done.
                  If disabled, the QDMA engine will determine if a descriptor is usable based only
                  on the ring pointers.
          - name: tx_wb_done
            bits: 1
            desc: Set the "done" bit in tx descriptor after sending. If disabled then the engine
                  will skip setting the done bit and rely on the driver to check the Done List
                  (i.e. `irq_en`).
          - name: burst_size
            bits: 2
            enum:
              16_BYTES: 0
              32_BYTES: 1
              64_BYTES: 2
              128_BYTES: 3
            desc: Number of bytes per DMA burst
          - name: rx_dma_busy
            bits: 1
            desc: RX DMA engine currently busy
          - name: rx_dma_en
            bits: 1
            desc: Enable RX DMA
          - name: tx_dma_busy
            bits: 1
            desc: TX DMA engine currently busy
          - name: tx_dma_en
            bits: 1
            desc: Enable TX DMA
  - type: opaque
    name: qchain0
    bytes: 24
    offset: 0x008
    decl: struct qchain_regs qchain0;
  - type: word
    bits: 32
    name: hwf_desc_addr
    desc: Hardware forwarding descriptor table address. This memory must be
          forward-descriptor-size (16 bytes) * fwd_desc_n in size.
    offset: 0x020
    typedef: dma_addr_t
  - type: word
    bits: 32
    name: hwf_data_addr
    desc: Hardware forwarding packet content address. This memory must be
          pkt_sz *  fwd_desc_n in size.
    typedef: dma_addr_t
  - type: bitfield
    name: hwf_cfg
    desc: Hardware forwarding configuration
    bits: 32
    fields:
      - bits: 2
      - bits: 2
        name: pkt_sz
        desc: The size of the packet buffers in hwf_data_addr (and therefore
              the maximum effective MTU).
        enum:
          "2048": 0
          "4096": 1
          "8192": 2
          "16384": 3
      - bits: 15
      - bits: 13
        name: low_desc_threshold
        short_name: low_th
        desc: When number of available (not busy) hardware descriptors is
              below this, generate an interrupt and pause hardware forwarding.
  - type: word
    bits: 32
  - type: struct
    name: hwf_cfg1
    desc: Hardware forwarding configuration (also called LMGR)
    fields:
      - type: bitfield
        bits: 8
        fields:
        - bits: 1
          name: start
          desc: Start up the hardware forwarding subsystem
        - bits: 6
        - bits: 1
          name: overhead_enabled
          short_name: overhead_en
          desc: When set, add overhead to packet size for accounting purposes
      - type: word
        bits: 8
        name: overhead
        desc: Amount of overhead to add to packet size for accounting
      - type: word
        bits: 16
        name: fwd_desc_n
        desc: Number of forward descriptors to use.
  - type: opaque
    bytes: 12
  - type: word
    bits: 32
    name: channel_retire
    desc: Referred to as QDMA_CSR_LMGR_CHNL_RETIRE
  - type: opaque
    bytes: 12
  - type: word
    name: int_status
    desc: When an interrupt is triggered, these are the pending events
    bits: 32
  - type: word
    name: int_enable
    desc: Enabled interrupts
    bits: 32
  - type: word
    offset: 0x058
    bits: 32
    name: tx_int_delay
    desc: Interrupt delay for reducing interrupt load
  - type: word
    offset: 0x05c
    bits: 32
    name: rx_int_delay
    desc: Interrupt delay for reducing interrupt load
  - type: struct
    name: done_queue
    short_name: doneq
    fields:
      - type: word
        bits: 32
        name: address
        short_name: addr
        typedef: dma_addr_t
      - type: struct
        name: config
        short_name: cfg
        fields:
          - type: word
            name: int_threshold
            bits: 16
            desc: When done queue is this full, fire an interrupt, max 4095
            short_name: intt
          - type: word
            name: size
            bits: 16
            short_name: sz
            desc: Size of the done queue buffer in 4 byte units, max 4095
      - type: word
        name: pop_back
        bits: 32
        desc: Pop this number of items from the back of the the done queue, max 255
      - type: struct
        name: state
        fields:
          - type: word
            name: length
            bits: 16
            desc: Number of items waiting in the queue
            short_name: len
          - type: word
            name: head_index
            bits: 16
            short_name: head
            desc: Index of the first item in the list
      - type: word
        bits: 32
        name: wait_time
        desc: If there is anything in the queue, fire an interrupt after this number of
              units of time, unit is 20 microseconds.

  - type: opaque
    bytes: 12

  - type: bitfield
    bits: 32
    offset: 0x80
    name: wrr_mode
    desc: WRR control register, called QDMA_CSR_TXWRR_MODE_CFG.
    fields:
      - bits: 1
        name: use_16b
        desc: If enabled, weighting is based on 16 byte units, otherwise 64 byte.
      - bits: 27
      - bits: 1
        name: by_byte
        desc: If enabled, weighting is by byte, otherwise by packet.
      - bits: 3

  - type: word
    bits: 32

  - type: struct
    name: wrr_weight
    desc: Read and write a WRR weight for a channel+queue pair. Called QDMA_CSR_TXWRR_WEIGHT_CFG.
    fields:
      - type: bitfield
        bits: 16
        fields:
          - bits: 1
            name: write
            only: write
            desc: Set this bit to write an entry, clear it to read
          - bits: 1
            name: done
            only: read
            desc: After performing an operation, this bit asserts from the hardware to
                  indicate the operation is done.
          - bits: 6
          - bits: 5
            name: channel
            only: write
            desc: Number of the channel to write or read WRR weight for
          - bits: 3
            name: queue
            only: write
            desc: Number of the queue to write or read WRR weight for
      - type: word
        bits: 8
      - type: word
        bits: 8
        name: value
        desc: The WRR weight to read or write for the configured channel+queue.

  - type: word
    bits: 32

  - type: word
    bits: 32
    name: buf_usage_cfg
    desc: Called QDMA_CSR_PSE_BUF_USAGE_CFG, a bitfield, TODO document

  - type: word
    bits: 32
    name: tx_meter_cfg
    desc: Called QDMA_CSR_EGRESS_RATEMETER_CFG, a bitfield, TODO document

  - type: word
    bits: 32
    name: tx_limit_cfg
    desc: Called QDMA_CSR_EGRESS_RATELIMIT_CFG, a bitfield, TODO document

  - type: word
    bits: 32
    name: tx_limit_param
    desc: Called QDMA_CSR_RATELIMIT_PARAMETER_CFG, a bitfield, per-channel tx rate limit, TODO document

  - type: struct
    name: tx_congest_cfg
    offset: 0xa0
    fields:
      - type: bitfield
        desc: Configuration for TX congestion dropping
        bits: 16
        fields:
          - bits: 1
            name: tail_drop_en
          - bits: 1
            name: dei_drop_en
            desc: Support 802.1ad DEI packet dropping
          - bits: 1
            name: dyncong_en
            desc: Enable dynamic congestion algorithm
          - bits: 1
          - bits: 1
            name: max_thr_blk_tx1
            desc: Block TX Ring1 when TX buffer usage exceeds max threshold (see tx_congest_thr)
          - bits: 1
            name: min_thr_blk_tx1
            desc: Block TX Ring1 when TX buffer usage exceeds min threshold (see tx_congest_thr)
          - bits: 1
            name: max_thr_blk_tx0
            desc: Block TX Ring0 when TX buffer usage exceeds max threshold (see tx_congest_thr)
          - bits: 1
            name: min_thr_blk_tx0
            desc: Block TX Ring0 when TX buffer usage exceeds min threshold (see tx_congest_thr)
          - bits: 2
            name: dyncong_margin
            enum:
              "0_PCT": 0
              "25_PCT": 1
              "50_PCT": 2
              "100_PCT": 3
          - bits: 2
            name: dyncong_dei_scale
            enum:
              HALF: 0
              QUARTER: 1
              EIGHTH: 2
              SIXTEENTH: 3
          - bits: 1
          - bits: 1
            name: dyncong_upd_wrr
            desc: Update dyanmic congestion after each update to WRR weights.
          - bits: 1
            name: dyncong_upd_txrx
            desc: Update dyanmic congestion after each TX or RX
          - bits: 1
            name: dyncong_upd_tick
            desc: Update dyanmic congestion after each tick
      - type: word
        name: dyncong_tick
        bits: 16
        desc: Dynamic congestion ticker rate in microseconds

  - type: struct
    name: tx_congest_thr
    fields:
      - type: word
        name: max
        desc: When total buffer usage exceeds this, drop all packets except VIP
        bits: 16
      - type: word
        name: min
        desc: When total buffer usage exceeds this, dynamic congestion control will start
        bits: 16

  - type: word
    bits: 32
    name: tx_per_ch_dthr
    desc: Called QDMA_CSR_TXQ_DYN_CHNLTHR_CFG, tx per-channel dynamic threshold max/min threshold, TODO document
  - type: word
    bits: 32
    name: tx_per_q_dthr
    desc: Called QDMA_CSR_TXQ_DYN_QUEUETHR_CFG, tx per-queue dynamic threshold max/min threshold, TODO document

  - type: opaque
    bytes: 32
    offset: 0xb0
    name: tx_per_q_sthr
    desc: Called QDMA_CSR_STATIC_QUEUE_THR(0..7), tx per-queue static thresholds, if dynamic thresholds are disabled, TODO document

  - type: opaque
    bytes: 16
  
  - type: struct
    name: debug
    fields:
      - type: bitfield
        bits: 32
        name: mem_ctl
        desc: Called QDMA_CSR_DBG_MEM_XS_CFG, used for debugging access to memory spaces.
        fields:
          - bits: 1
            name: write
            only: write
            desc: Set this bit when writing a value, otherwise clear it to Read
          - bits: 1
            name: done
            only: read
            desc: Becomes set when the command is completed
          - bits: 3
          - bits: 3
            name: dataset
            only: write
            desc: Which dataset to read/write in, called QDMA_DbgMemXsMemSel_t.
            enum:
              DESC: 0
              QUEUE: 1
              QOS_WEIGHT_CTR: 2
              DMA_IDX: 3
              BUF_MON: 4
              RL_PARAM: 5
              VCH_WEIGHT: 6
          - bits: 3
          - bits: 5
            name: word_of_elem
            only: write
            desc: Which word of the selected element to read/write, called DBG_MEM_XS_BYTESEL_SHIFT
          - bits: 16
            name: elem
            only: write
            desc: Which element of the dataset to select
      - type: word
        bits: 32
        name: mem_lo
        desc: Read or write the low bits of a memory element (use with mem_ctl)
              Called QDMA_CSR_DBG_MEM_XS_DATA_LO.
      - type: word
        bits: 32
        name: mem_hi
        desc: Read or write the high bits of a memory element (use with mem_ctl)
              Called QDMA_CSR_DBG_MEM_XS_DATA_HI. Not used in practice.
      - type: word
        bits: 32
      - type: word
        bits: 32
        name: hwf_desc_free
        desc: Called QDMA_CSR_DBG_LMGR_STATUS, number of free hardware forwarding descriptors
      - type: word
        bits: 32
        name: hwd_buf_used
        desc: Number of bytes of buffer used for hardwre forwarding
      - type: word
        bits: 32
        name: probe_lo
        desc: Called QDMA_CSR_DBG_QDMA_PROBE_LO, unknown usage, TODO document
      - type: word
        bits: 32
        name: probe_hi
        desc: Called QDMA_CSR_DBG_QDMA_PROBE_HI, unknown usage, TODO document

  - type: struct
    name: rxring_size
    offset: 0x100
    fields:
      - type: word
        bits: 16
        name: rxring0_size
        desc: Size of RX ring zero, maximum 4095
      - type: word
        bits: 16
        name: rxring1_size
        desc: Size of ring one, maximum 4095
  - type: struct
    name: rxring_low
    offset: 0x104
    fields:
      - type: word
        bits: 16
        name: rxring0_low
        desc: Trigger interrupt when number of free RX descs <= this, maximum 4095
      - type: word
        bits: 16
        name: rxring1_low
        desc: Trigger interrupt when number of free RX descs <= this, maximum 4095
  - type: opaque
    name: qchain1
    bytes: 24
    offset: 0x108
    decl: struct qchain_regs qchain1;

  - type: word
    bits: 32
    name: cpu_rx_limit
    desc: CPU protection RX limit, TODO document
  - type: word
    bits: 32
    name: cpu_rx_limit_val
    desc: CPU protection RX limit, TODO document

  - type: opaque
    bytes: 20
  
  - type: word
    bits: 32
    name: vch_wrr
    desc: Virtual channel WRR weighting, TODO document
  - type: word
    bits: 32
    name: vch_qmode
    desc: Virtual channel QoS mode (WRR / SP), TODO document

  - type: opaque
    bytes: 28

  - type: word
    bits: 32
    name: ch_lim_en
    desc: Per-channel rate-limit enable, each bit corriponds to one channel

  - type: opaque
    bytes: 28
  
  - type: opaque
    bytes: 16
    offset: 0x180
    name: ch_qmode
    desc: Per-channel queue prioritization mode (WRR / SP), TODO document
  
  - type: opaque
    bytes: 112

  - type: opaque
    offset: 0x200
    name: ch_tx_rate
    desc: Channel data rate, each word corrisponds to 2 channels, upper 16 bits is the odd channel number, lower 16 is the even.
    bytes: 64

  - type: opaque
    bytes: 64

  - type: opaque
    offset: 0x280
    bytes: 32
    name: ch_drop
    desc: Drop counter for normal packets, each byte corrisponds to one of the 32 channels.
  
  - type: opaque
    bytes: 32
  
  - type: opaque
    offset: 0x2c0
    bytes: 32
    name: ch_dei_drop
    desc: Drop counter for Drop-Elligable (DEI) packets, each byte corrisponds to one of the 32 channels.

  - type: opaque
    bytes: 32
  
  - type: opaque
    offset: 0x300
    bytes: 512
    name: pkt_ctrs
    desc: Every other word is a counter config and a counter value, called
          QDMA_CSR_DBG_CNTR_CFG / QDMA_CSR_DBG_CNTR_VAR. Definitely 40 counters,
          possible 64. TODO document

  - type: opaque
    offset: 0x500
    bytes: 2816
    # Rest of the page